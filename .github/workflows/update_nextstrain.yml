name: Monthly CVA16 Pipeline Run
on: 
  workflow_dispatch:  # Manual trigger for testing
  schedule:
    - cron:  '0 0 1 * *'  # 1st of month, midnight UTC

jobs:
  pipeline:
    runs-on: ubuntu-latest
    steps:
      - name:  Checkout code repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout data repository
        uses: actions/checkout@v4
        with:
          repository: hodcroftlab/nextstrain-builds-data
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: data-source

      - name: Copy CVA16 data to correct location
        run:  |
          # Create data directory if it doesn't exist
          mkdir -p data
          
          # Copy all CVA16-specific data
          if [ -d "data-source/coxsackievirus_a16" ]; then
            cp -r data-source/coxsackievirus_a16/* data/
            echo "CVA16 data copied successfully"
          else
            echo "ERROR: coxsackievirus_a16 folder not found in nextstrain-builds-data"
            exit 1
          fi
          
          # Clean up temporary directory
          rm -rf data-source
          
          # Verify critical files exist before proceeding
          echo "Files in data/:"
          ls -lh data/
          
          # Check for required files
          required_files=("meta_public.tsv" "meta_collab.tsv" "subgenotypes_rivm.csv" "clades_vp1.tsv" "strain_names_previous_run.tsv")
          for file in "${required_files[@]}"; do
            if [ ! -f "data/$file" ]; then
              echo "⚠️  Warning: $file not found in data/"
            fi
          done

      - name:  Set up Conda
        uses:  conda-incubator/setup-miniconda@v3
        with: 
          auto-update-conda: true
          python-version: "3.9"
          activate-environment: nextstrain
          environment-file: environment.yaml

      - name: Clean previous results
        shell: bash -l {0}
        run: |
          snakemake --cores 1 clean || echo "Clean completed"

      - name: Run full pipeline
        shell: bash -l {0}
        env:  
          REMOTE_GROUP:  ${{ secrets.NEXTSTRAIN_REMOTE_GROUP }}
        run:  |
          snakemake --cores 10 next_update \
            --use-conda \
            --rerun-incomplete \
            --printshellcmds 

      - name: Upload to Nextstrain
        shell: bash -l {0}
        if: success()  # Only run if pipeline succeeded
        env: 
          NEXTSTRAIN_USERNAME: ${{ secrets.NEXTSTRAIN_USERNAME }}
          NEXTSTRAIN_PASSWORD: ${{ secrets.NEXTSTRAIN_PASSWORD }}
          REMOTE_GROUP: ${{ secrets.NEXTSTRAIN_REMOTE_GROUP }}
        run: |
          snakemake --cores 2 upload

      - name:   Commit and Push Results
        shell:  bash -l {0}
        if: success()  # Only push if everything succeeded
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin automatic-updates
          git add auspice/
          git commit -m "chore:  update CVA16 builds [skip ci]" || echo "No changes to commit"
          git push origin automatic-updates

      - name: Upload workflow artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name:  pipeline-results
          path: auspice/
          retention-days: 30